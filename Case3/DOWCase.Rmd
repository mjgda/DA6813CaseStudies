---
title: "DOW Jones Index Case"
author: "Visha Arumugam(vcu526), Michael Grogan(ldl776),Sanyogita Apte(jlh562)"
date: "October 31, 2021"
output: html_document
---
<style type="text/css">

h1.title {
  font-size: 38px;
  text-align: center;
}
h4.author { 
  font-size: 18px;
  text-align: center;
}
h4.date { 
  font-size: 18px;
  text-align: center;
}
</style>
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Task: Build models to predict stock prices and evaluate risks of stocks. 
#Target per percent_change_next_weeks_price
#Models to try: Linear Regression, Decision Trees, SVM

#All use-able variables:
#percent_change_price+percent_change_volume_over_last_wk+time+open+days_to_next_dividend+percent_return_next_dividend+close+high+low+stock+previous_weeks_volume+volume

#Variables used in original study:
#percent_change_price+percent_change_volume_over_last_wk+days_to_next_dividend+percent_return_next_dividend


library(Boruta)
library(caret)
library(imputeTS)
library(e1071)
library(rpart)
library(tseries)
library(quantmod)
library(reshape2)
library(lubridate)
library(ggplot2)
library(tidyverse)

setwd("~/GitHub/DA6813CaseStudies/Case3")
#setwd("~/MSDA/Fall 2021/GitHub")
#setwd("~/MSDA/Fall 2021/GitHub/DA6813CaseStudies")
#setwd("~/MSDA/Fall 2021/Data Analytics Applications/Case Study 1/DA6813CaseStudies/Case2")
#setwd("~/MSDA/Fall 2021/Data Analytics Applications/Case Study 1/DA6813CaseStudies/Case3")
```






```{r}
DOWdata<-read.table('dow_jones_index.data',sep=",",header=T)


for(i in c(4:7,12:13)){
  DOWdata[[i]]<-as.numeric(gsub('\\$','',DOWdata[[i]]))
  
}
DOWdata$date<-as.Date(DOWdata$date,format ="%m/%d/%Y")
DOWdata<-na_ma(DOWdata)
DOWdata$time<-as.numeric(DOWdata$date)
q1<-unique(DOWdata$date[DOWdata$quarter==1])
q2<-unique(DOWdata$date[DOWdata$quarter==2])


for(j in list(q1,q2)){
  for(i in 1:length(j)){
    DOWdata$time[DOWdata$date==j[i]]<-i
}
}

# Open Lag
DOWdata=DOWdata %>%
group_by(stock)%>%
mutate(open_lag=dplyr::lag(open,n=1))

# High Lag
DOWdata=DOWdata %>%
group_by(stock)%>%
mutate(high_lag=dplyr::lag(high,n=1))

# Low Lag
DOWdata=DOWdata %>%
group_by(stock)%>%
mutate(low_lag=dplyr::lag(low,n=1))

# Close Lag
DOWdata=DOWdata %>%
group_by(stock)%>%
mutate(close_lag=dplyr::lag(close,n=1))

# percent_change_price
DOWdata=DOWdata %>%
group_by(stock)%>%
mutate(percent_change_price_lag=dplyr::lag(percent_change_price,n=1))

# Percent Change Volume Over Last Week Lag
DOWdata=DOWdata %>%
group_by(stock)%>%
mutate(percent_change_volume_over_last_wk_lag=dplyr::lag(percent_change_volume_over_last_wk,n=1))

# Percent Change Next Weeks Price Lag
DOWdata=DOWdata %>%
group_by(stock)%>%
mutate(percent_change_next_weeks_price_lag=dplyr::lag(percent_change_next_weeks_price,n=1))

# days_to_next_dividend_lag
DOWdata=DOWdata %>%
group_by(stock)%>%
mutate(days_to_next_dividend_lag=dplyr::lag(days_to_next_dividend,n=1))

# Percent Return Next Dividend Lag
DOWdata=DOWdata %>%
group_by(stock)%>%
mutate(percent_return_next_dividend_lag=dplyr::lag(percent_return_next_dividend,n=1))

# Next Weeks Close Lag
DOWdata=DOWdata %>%
group_by(stock)%>%
mutate(next_weeks_close_lag=dplyr::lag(next_weeks_close,n=1))

# Next Weeks Open Lag
DOWdata= DOWdata %>%
group_by(stock) %>%
mutate(next_weeks_open_lag = dplyr::lag(next_weeks_open, n =1))

# Volume Lag
DOWdata= DOWdata %>%
group_by(stock) %>%
mutate(volume_lag = dplyr::lag(volume, n =1))

# Previous Volume Lag
DOWdata= DOWdata %>%
group_by(stock) %>%
mutate(previous_weeks_volume_lag = dplyr::lag(previous_weeks_volume, n =1))

train<-DOWdata[DOWdata$quarter==1,]
test<-DOWdata[DOWdata$quarter==2,]


```
```{r  ExploratoryAnalysis}
ggplot(data=DOWdata, aes(x=date, y=percent_change_next_weeks_price,color=stock)) +
  geom_point() +
  xlab("")

ggplot(data=DOWdata, aes(x=date, y=volume,color=stock)) +
  geom_point() +
  xlab("")
 
ggplot(data=DOWdata, aes(x=date, y=percent_change_price,color=stock)) +
  geom_point() +
  xlab("")

ggplot(data=DOWdata, aes(x=date, y=percent_change_volume_over_last_wk,color=stock)) +
  geom_point() +
  xlab("")

ggplot(data=DOWdata, aes(x=date, y=percent_return_next_dividend,color=stock)) +
  geom_point() +
  xlab("")

## Based on the time series plot on various stocks, it can be inferred that the data follows the stationary pattern over the variables volume,percent_change_price,percent_change_volume_over_last_wk,percent_change_next_weeks_price and percent_return_next_dividend
```

```{r}
lag.plot(train$percent_change_next_weeks_price,set.lags = 1:8,layout = c(2,4),labels=FALSE,main = paste("Lag plot for Percentage of price change for next week:","Total"))

for(i in unique(test$stock)){

trainstock<-train[train$stock==i,]
y=train$percent_change_next_weeks_price[train$stock==i]
lag.plot(y,set.lags = 1:8,layout = c(2,4),labels=FALSE,main = paste("Lag plot for Percentage of price change for next week:",i))
}


lag.plot(train$percent_change_price,set.lags = 1:8,layout = c(2,4),labels=FALSE,main = "Lag plot for Percentage of Price changes:Total")
for(i in unique(test$stock)){

trainstock<-train[train$stock==i,]
y=train$percent_change_price[train$stock==i]
lag.plot(y,set.lags = 1:8,layout = c(2,4),labels=FALSE,main = paste("Lag plot for Percentage of Price changes:",i))
}

for(i in unique(test$stock)){

trainstock<-train[train$stock==i,]
y=train$percent_change_volume_over_last_wk[train$stock==i]
lag.plot(y,set.lags = 1:8,layout = c(2,4),labels=FALSE,
         main = "Lag Plot for Percent change in volume of stocks traded compared to the previous week")
}

lag.plot(train$percent_return_next_dividend,set.lags = 1:8,layout = c(2,4),labels=FALSE,main = paste("Percentage of return in the next dividend: Total"))
for(i in unique(test$stock)){

trainstock<-train[train$stock==i,]
y=train$percent_return_next_dividend[train$stock==i]
lag.plot(y,set.lags = 1:8,layout = c(2,4),labels=FALSE,main = paste("Lag Plot for Percentage of return in the next dividend:",i)) 
}
```



```{r}
#index for CAPM
DOWIndex <- read.csv("DOW_2011Q1Q2.csv", header=TRUE, sep=",") 
closedf<-as.data.frame.matrix(xtabs(~date+stock,DOWdata))
for(i in unique(DOWdata$stock)){
closedf[i]<-DOWdata$close[DOWdata$stock==i]
}

closedf$DOW<-DOWIndex[,5]

Returns<-na.omit(apply(closedf,2,Delt))
boxplot(Returns,main="Expected Return", xlab="Stock Picks", ylab="Return",las=2)

CAPM<-data.frame(matrix(ncol = 2, nrow = 0))

for(i in unique(DOWdata$stock)){
betta<-summary(lm(as.formula(paste(i,"DOW",sep="~")),as.data.frame(Returns)))
CAPM<-rbind(CAPM,c(i,betta$coefficients[2,1]))
}
colnames(CAPM) <- c("Stock","Beta")

```




```{r}
#writing formulas

#static formulas
targety<-"percent_change_next_weeks_price"
fvar<-c("percent_change_price","percent_change_volume_over_last_wk","time",
        "open","days_to_next_dividend","percent_return_next_dividend","close",
        "high","low","stock","previous_weeks_volume","volume")

flagvar=c("percent_change_price_lag","percent_change_volume_over_last_wk_lag",
        "open_lag","days_to_next_dividend_lag","percent_return_next_dividend_lag","close_lag",
        "high_lag","low_lag","stock","previous_weeks_volume_lag","volume_lag")

flagvarsvm<-c("percent_change_price_lag","percent_change_volume_over_last_wk_lag",
        "open_lag","days_to_next_dividend_lag","percent_return_next_dividend_lag","close_lag",
        "high_lag","low_lag","previous_weeks_volume_lag","volume_lag")

ovar<-c("percent_change_price","percent_change_volume_over_last_wk",
        "days_to_next_dividend","percent_return_next_dividend")


svar<-c("time","time:percent_return_next_dividend","close","stock")



slagvar<-c("percent_return_next_dividend_lag","low_lag","open_lag","close_lag","high_lag","volume_lag",
        "previous_weeks_volume_lag","stock")

#svm needs to have stock excluded because it can't calculate without variation
fvarsvm<-c("percent_change_price","percent_change_volume_over_last_wk","time",
        "open","days_to_next_dividend","percent_return_next_dividend","close",
        "high","low","previous_weeks_volume","volume")

svarsvm<-c("time","time:percent_return_next_dividend","close")

slagvarsvm<-c("percent_return_next_dividend_lag","low_lag","open_lag","close_lag","high_lag","volume_lag",
        "previous_weeks_volume_lag")


selectformula<-as.formula(paste(targety,paste(svar,collapse="+"),sep="~"))
fullformula<-as.formula(paste(targety,paste(fvar,collapse="+"),sep="~"))
originalformula<-as.formula(paste(targety,paste(ovar,collapse="+"),sep="~"))

selectformulasvm<-as.formula(paste(targety,paste(svarsvm,collapse="+"),sep="~"))
fullformulasvm<-as.formula(paste(targety,paste(fvarsvm,collapse="+"),sep="~"))
slagformulasvm<-as.formula(paste(targety,paste(slagvarsvm,collapse="+"),sep="~"))


fulllagformula<-as.formula(paste(targety,paste(flagvar,collapse="+"),sep="~"))
slagformula<-as.formula(paste(targety,paste(slagvar,collapse="+"),sep="~"))

fulllagformulasvm<-as.formula(paste(targety,paste(flagvarsvm,collapse="+"),sep="~"))
```


```{r, echo=F, eval=F}
#boruta_var_imp_output=Boruta(fulllagformula,data=na.omit(train),doTrace=1)
#boruta_signif <- getSelectedAttributes(boruta_var_imp_output, withTentative = TRUE)
#boruta_roug_fix_mod=TentativeRoughFix(boruta_var_imp_output)
#Variable Importance Scores
#boruta_imps <- attStats(boruta_roug_fix_mod)
#boruta_imps2 = boruta_imps[boruta_imps$decision != 'Rejected', c('meanImp', 'decision')]
#boruta_imps2[order(-boruta_imps2$meanImp), ]
#plot(boruta_var_imp_output, cex.axis=.7, las=2, xlab="", main="Variable Importance")
```


```{r}
## Train models
selectlm<-glm(formula=selectformula,family="gaussian",data=train)
fulllm<-glm(formula=fullformula,family="gaussian",data=train)
originallm<-glm(formula=originalformula,family="gaussian",data=train)
fulllaglm<-glm(formula=fulllagformula,family="gaussian",data=train)
siglaglm<-glm(formula=slagformula,family="gaussian",data=train)


selectsvm<-svm(formula=selectformulasvm,data=train)
fullsvm<-svm(formula=fullformulasvm,data=train)
originalsvm<-svm(formula=originalformula,data=train)
fulllagsvm<-svm(formula=fulllagformulasvm,data=train)
siglagsvm<-svm(formula=slagformulasvm,data=train)


#selecttree<-rpart(formula=selectformulasvm,method = "anova",data=train) can't handle interaction
fulltree<-rpart(formula=fullformulasvm,method = "anova",data=train)
originaltree<-rpart(formula=originalformula,method = "anova",data=train)
fulllagtree<-rpart(formula=fulllagformulasvm,method = "anova",data=train)
siglagtree<-rpart(formula=slagformulasvm,method = "anova",data=train)
```



```{r, echo=F}
#Change model to compare
#Compares prediction on data that was used to train the model and then on new test data
#Due to some stocks having more outliers than average, the training data can yield even worse predictions


modellabels<-c("selectlm","fulllm","originallm","fulllaglm","siglaglm","selectsvm","fullsvm","originalsvm",
               "fulllagsvm","siglagsvm","fulltree","originaltree","fulllagtree","siglagtree")
modellist<-list(selectlm,fulllm,originallm,fulllaglm,siglaglm,selectsvm,fullsvm,originalsvm,fulllagsvm,siglagsvm,
                fulltree,originaltree,fulllagtree,siglagtree)


results<-as.data.frame(matrix(ncol=5,nrow=0))
colnames(results) <- c("Model","Stock","TrainMSE","TestMSE","Beta")

for(m in 1:length(modellist)){
for(i in unique(test$stock)){
model<-modellist[[m]]
target<-test[test$stock==i,]
prediction<-predict(model,target)


trainstock<-train[train$stock==i,]
trainedpred<-predict(model,trainstock)

trainmse<-mean((trainedpred-trainstock$percent_change_next_weeks_price)^2)
testmse<-mean((prediction-target$percent_change_next_weeks_price)^2)

resultrow<-list(modellabels[m],i,trainmse,testmse,CAPM$Beta[CAPM$Stock==i])
print(modellabels[m])
print(length(resultrow))
#print(resultrow)
results<-rbind(results,resultrow)
}
}
colnames(results) <- c("Model","Stock","TrainMSE","TestMSE","Beta")
results$Difference<-(results$TestMSE-results$TrainMSE)


```




```{r}
#ggplot(data=results[results$Model=="siglagsvm",], aes(x=TestMSE, y=Difference,color=Stock)) +
#  geom_point() +
#  xlab("")
```


```{r}
#Change model to compare
#Compares prediction on data that was used to train the model and then on new test data
#Due to some stocks having more outliers than average, the training data can yield even worse predictions


modellabels<-c("selectlm","fulllm","originallm","fulllaglm","siglaglm","selectsvm","fullsvm","originalsvm",
               "fulllagsvm","siglagsvm","fulltree","originaltree","fulllagtree","siglagtree")
modellist<-list(selectlm,fulllm,originallm,fulllaglm,siglaglm,selectsvm,fullsvm,originalsvm,fulllagsvm,siglagsvm,
                fulltree,originaltree,fulllagtree,siglagtree)


overallresults<-as.data.frame(matrix(ncol=3,nrow=0))
colnames(overallresults) <- c("Model","TrainMSE","TestMSE")

for(m in 1:length(modellist)){

model<-modellist[[m]]
target<-test
prediction<-predict(model,target)


trainstock<-train
trainedpred<-predict(model,trainstock)

trainmse<-sqrt(mean((trainedpred-trainstock$percent_change_next_weeks_price)^2))
testmse<-sqrt(mean((prediction-target$percent_change_next_weeks_price)^2))

resultrow<-list(modellabels[m],trainmse,testmse)
#print(resultrow)
overallresults<-rbind(overallresults,resultrow)

}
colnames(overallresults) <- c("Model","TrainRMSE","TestRMSE")
overallresults$Difference<-(overallresults$TestRMSE-overallresults$TrainRMSE)

overallresults[order(overallresults$TestRMSE),]
```

```{r}
#ggplot(data=results[results$Model=="siglagsvm",], aes(x=TestMSE, y=Difference,color=Stock)) +
#  geom_point() +
#  xlab("")
```


```{r}
table((results$Model[results$TestMSE<5]))

table((results$Model[results$Difference<3]))

```
The selectSVM has the most stocks with a TestMSE less than 5 and also the most Stocks that have a difference 
```{r}

model<-selectsvm
for(i in unique(test$stock)){

target<-test[test$stock==i,]
prediction<-predict(model,target)


trainstock<-train[train$stock==i,]
trainedpred<-predict(model,trainstock)


trainmse<-mean((trainedpred-trainstock$percent_change_next_weeks_price)^2)
testmse<-mean((prediction-target$percent_change_next_weeks_price)^2)


par(mfrow = c(1, 2))
plot(trainstock$time,trainstock$percent_change_next_weeks_price,main=paste("Train:",i,"MSE:",round(trainmse,3)))
lines(trainstock$percent_change_next_weeks_price,col="red")
lines(trainedpred,col="blue")

plot(target$time,target$percent_change_next_weeks_price,main=paste("Test:",i,"MSE:",round(testmse,3)))
lines(target$percent_change_next_weeks_price,col="red")
lines(prediction,col="blue")

}
```






```{r}
# Execute the linear regression and Check whether any autocorrealtion exists between the time period
stock_lm_formula <- "percent_change_next_weeks_price ~ date+percent_change_price+percent_change_volume_over_last_wk+days_to_next_dividend+percent_return_next_dividend"
```

```{r}
Residual_df<-data.frame(matrix(ncol = 3, nrow = 0))
for(i in unique(train$stock)){

trainstock<-train[train$stock==i,]
stock_lm=lm(formula = stock_lm_formula,data = trainstock)

stock_lm_res=resid(stock_lm)
date=as.Date(trainstock$date,format ="%m/%d/%Y")
stock_nam=rep(i,times=length(trainstock$stock))
Res_data<- data.frame(matrix(stock_nam),matrix(date),matrix(stock_lm_res))
  
Residual_df <- rbind(Residual_df, Res_data)
}
colnames(Residual_df) <- c("Stock","date","residuals")
str(Residual_df)
Residual_df$date<-as_date(Residual_df$date)
```
```{r}
ggplot(data=Residual_df, aes(x=date, y=residuals,color=Stock)) +
  geom_point() +
  geom_line()+
  xlab("")+
  ylab("Residuals")
```




### I - Executive Summary


### II - The Problem

It is well-established that the behavior of stock market prices in the aggregate and in the long term is to trend upwards as a result of improvements in technology and increases in production efficiency, both of which are positively correlated with time as individuals and industry build on the knowledge and expertise of previous generations. It is also well-established that in the short-term stock prices are not predictable, especially based on historical information, which is to say that whether a stock or portfolio increased in value has little to no bearing on whether the stock will increase or decrease the following day.
Metrics about the financial health of the company can tell more about the prospects for the stock price of that company, such as the price-to-earnings ratio, or the level of debt of the company. But even with this level of detail, there is still very little predictive capability on time scales as small as days or weeks.

But in the spirit of validating industry and academic consensus, we will attempt to use historical stock information to build a model that is able to predict future stock performance.

In addition to generating a model for predicting future performance based on past performance, we will also perform an analysis on each of the component stocks vs the overall index in order to identify stocks that vary the most with the index as well as those that most closely align with the index.


## III - Review of Related Literature


## IV - Methodology

We will use the dataset from the study by Brown, M. S., Pelosi, M. & Dirska, H for testing their genetic algorithm. This dataset is the first two quarters of 2011, and we will use the first quarter for training our models, and then the second quarter for testing the effectiveness of the models.

As the target variable for training the models we use the "percent_change_next_weeks_price" field in the dataset. We know value of this variable because this is all historical information, but for the purposes of training the model we will only have access to the the data that we would know in the "present". This means for the purpose of training our models we exclude the other variables that relate to the "next_week" because in the real world we wouldn't have access to that information yet.

We will train a models using a combination of algorithms and component variables. The algorithms we will use are Linear Regression, linear Support Vector Machine, and Decistion Tree. For the predictor selections, we will use a full model, a model using the variables that were used in the aforementioned original study ("percent_change_price","percent_change_volume_over_last_wk","days_to_next_dividend","percent_return_next_dividend"). We will also use feature sets that are comprised of the lagged values of all the numeric variables in order to try to capture any delayed effect. This means for those models the following week's stock performance will be predicted using data from two weeks before.

Additionally we will use a selection of variables that we selected by trial and error that generated a linear model with the most significant variables, which are as follows: ("time","time:percent_return_next_dividend","close")
This is also the smallest set of predictors that we will use for any of the models.

After training all of the models, we will compare the Root Mean Squared Error of each model to determine which model performs with the most accuracy at the total index level. And because the exercise is ultimately to determine whether stocks performance can be accurately predicted, we will apply the models to the individual stocks to see how well the model trained on the all of the data performs on individual stocks.


### V - Data

The data is composed of the weekly stock price and volume information for the first 25 weeks of 2011, with Q1 serving as the training data and Q2 serving as the test data. In order to allow for the time element to contribute to the prediction it needs to be converted to a form that can apply equally to each period even though their dates are unique.

### VI - Findings


### Appendix

